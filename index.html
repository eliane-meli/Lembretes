<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lembretes de Atividades</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            width: 350px;
            height: 500px;
        }

        .floating-app {
            width: 100%;
            height: 100%;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 18px;
            font-weight: 600;
        }

        .app-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .app-content {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #34a853;
        }

        .status-dot.disconnected {
            background-color: #ea4335;
        }

        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #4285f4;
        }

        .activity-item.checked {
            opacity: 0.7;
            border-left-color: #34a853;
        }

        .activity-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .activity-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .activity-time {
            font-size: 11px;
            color: #888;
            text-align: right;
        }

        .no-activities {
            text-align: center;
            padding: 20px;
            color: #888;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .next-reminder {
            background-color: #e8f5e8;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #2e7d32;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #34a853;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .notification.hidden {
            display: none;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-icon {
            font-size: 20px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="floating-app">
        <div class="app-header">
            <div class="app-title">Lembretes de Atividades</div>
            <div class="app-controls">
                <button class="btn" id="refreshBtn" title="Atualizar">↻</button>
            </div>
        </div>
        <div class="app-content">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Carregando...</span>
            </div>
            <div id="nextReminderInfo" class="next-reminder"></div>
            <div id="contentArea">
                <div class="loading">Carregando atividades...</div>
            </div>
        </div>
    </div>

    <div class="notification hidden" id="notification">
        <div class="notification-icon">⏰</div>
        <div class="notification-content">
            <div class="notification-title">Lembrete de Atividade</div>
            <div class="notification-message" id="notificationMessage"></div>
        </div>
        <button class="notification-close" id="notificationClose">×</button>
    </div>

    <script>
        // Horários fixos para lembretes
        const FIXED_REMINDER_TIMES = ['19:30', '04:00'];
        
        // Elementos DOM
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const contentArea = document.getElementById('contentArea');
        const nextReminderInfo = document.getElementById('nextReminderInfo');
        const refreshBtn = document.getElementById('refreshBtn');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');
        const notificationClose = document.getElementById('notificationClose');

        // Estado do aplicativo
        let activities = [];
        let reminderInterval;
        let fixedTimeInterval;

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            loadActivities();
            setupEventListeners();
            startReminderSystem();
            updateNextReminderInfo();
        });

        // Configurar ouvintes de eventos
        function setupEventListeners() {
            refreshBtn.addEventListener('click', loadActivities);
            notificationClose.addEventListener('click', () => {
                notification.classList.add('hidden');
            });
        }

        // Carregar atividades da planilha
        function loadActivities() {
            contentArea.innerHTML = '<div class="loading">Carregando atividades...</div>';
            updateStatus(true, "Conectando...");

            google.script.run
                .withSuccessHandler(handleActivitiesLoad)
                .withFailureHandler(handleLoadError)
                .getActivities();
        }

        // Manipular carregamento bem-sucedido
        function handleActivitiesLoad(response) {
            if (response.success) {
                activities = response.data;
                renderActivities();
                updateStatus(true, "Conectado à planilha");
            } else {
                handleLoadError(response.error);
            }
        }

        // Manipular erro de carregamento
        function handleLoadError(error) {
            contentArea.innerHTML = `
                <div class="error">
                    Erro ao carregar atividades: ${error}
                </div>
                <button onclick="loadActivities()" style="
                    background: #4285f4;
                    color: white;
                    border: none;
                    padding: 10px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    width: 100%;
                ">Tentar Novamente</button>
            `;
            updateStatus(false, "Erro de conexão");
        }

        // Renderizar lista de atividades
        function renderActivities() {
            if (activities.length === 0) {
                contentArea.innerHTML = '<div class="no-activities">Nenhuma atividade encontrada</div>';
                return;
            }

            const activitiesHTML = activities.map(activity => `
                <div class="activity-item ${activity.concluida ? 'checked' : ''}">
                    <input type="checkbox" class="activity-checkbox" ${activity.concluida ? 'checked' : ''} 
                           onchange="toggleActivity(${activity.id - 1}, this.checked)">
                    <div class="activity-text">
                        ${activity.atividade}
                        ${activity.lembreteEspecifico ? 
                          `<br><small style="color: #666;">Horário: ${activity.lembreteEspecifico}</small>` : ''}
                    </div>
                    ${activity.ultimoLembrete ? 
                      `<div class="activity-time">Lembrado: ${formatTime(activity.ultimoLembrete)}</div>` : ''}
                </div>
            `).join('');

            contentArea.innerHTML = `<div class="activity-list">${activitiesHTML}</div>`;
        }

        // Alternar estado de conclusão da atividade
        function toggleActivity(rowIndex, concluida) {
            google.script.run
                .withSuccessHandler(() => {
                    // Atualiza localmente
                    const activity = activities.find(a => a.id === rowIndex + 1);
                    if (activity) {
                        activity.concluida = concluida;
                        renderActivities();
                    }
                })
                .withFailureHandler((error) => {
                    alert('Erro ao atualizar atividade: ' + error);
                    loadActivities(); // Recarrega para garantir sincronização
                })
                .updateActivityStatus(rowIndex, concluida);
        }

        // Iniciar sistema de lembretes
        function startReminderSystem() {
            // Verificar por atividades pendentes a cada minuto
            reminderInterval = setInterval(checkForReminders, 60000);
            
            // Verificar horários fixos a cada minuto
            fixedTimeInterval = setInterval(checkFixedTimeReminders, 60000);
            
            // Verificar imediatamente ao iniciar
            setTimeout(() => {
                checkForReminders();
                checkFixedTimeReminders();
            }, 2000);
        }

        // Verificar atividades para lembrer (sistema a cada hora)
        function checkForReminders() {
            const now = new Date();
            const pendingActivities = activities.filter(activity => 
                !activity.concluida && 
                shouldRemind(activity, now)
            );

            if (pendingActivities.length > 0) {
                showReminder(pendingActivities, "Lembrete Horário");
                
                // Atualizar timestamp do último lembrete
                pendingActivities.forEach(activity => {
                    google.script.run
                        .withFailureHandler((error) => console.error('Erro ao atualizar lembrete:', error))
                        .updateLastReminder(activity.id - 1);
                });
            }
        }

        // Verificar se deve lembrar a atividade
        function shouldRemind(activity, now) {
            if (!activity.ultimoLembrete) return true;
            
            const lastReminder = new Date(activity.ultimoLembrete);
            const timeDiff = now - lastReminder;
            const oneHour = 60 * 60 * 1000; // 1 hora em milissegundos
            
            return timeDiff >= oneHour;
        }

        // Verificar lembretes em horários fixos
        function checkFixedTimeReminders() {
            const now = new Date();
            const currentTime = formatTime(now);
            
            // Verificar se é um dos horários fixos
            if (FIXED_REMINDER_TIMES.includes(currentTime)) {
                const pendingActivities = activities.filter(activity => 
                    !activity.concluida
                );

                if (pendingActivities.length > 0) {
                    showReminder(pendingActivities, `Lembrete ${currentTime}`);
                    
                    // Atualizar timestamp do último lembrete
                    pendingActivities.forEach(activity => {
                        google.script.run
                            .withFailureHandler((error) => console.error('Erro ao atualizar lembrete:', error))
                            .updateLastReminder(activity.id - 1);
                    });
                }
            }

            // Atualizar informação do próximo lembrete
            updateNextReminderInfo();
        }

        // Atualizar informação do próximo lembrete
        function updateNextReminderInfo() {
            const now = new Date();
            const currentTime = formatTime(now);
            
            // Encontrar o próximo horário fixo
            let nextFixedTime = null;
            for (const time of FIXED_REMINDER_TIMES) {
                if (time > currentTime) {
                    nextFixedTime = time;
                    break;
                }
            }
            
            // Se não encontrou, pega o primeiro do próximo dia
            if (!nextFixedTime) {
                nextFixedTime = FIXED_REMINDER_TIMES[0];
            }
            
            nextReminderInfo.innerHTML = `
                <strong>Próximos lembretes:</strong><br>
                • Horários fixos: ${FIXED_REMINDER_TIMES.join(', ')}<br>
                • Próximo: ${nextFixedTime}<br>
                • A cada hora para atividades pendentes
            `;
        }

        // Mostrar lembrete
        function showReminder(activities, title) {
            const activityText = activities.length === 1 
                ? activities[0].atividade 
                : `${activities.length} atividades pendentes:\n${activities.map(a => `• ${a.atividade}`).join('\n')}`;
                
            notificationMessage.textContent = activityText;
            notification.querySelector('.notification-title').textContent = title;
            notification.classList.remove('hidden');
            
            // Ocultar notificação após 10 segundos
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 10000);
        }

        // Atualizar indicador de status
        function updateStatus(connected, message) {
            statusDot.classList.toggle('disconnected', !connected);
            statusText.textContent = message;
        }

        // Formatar hora para exibição (HH:MM)
        function formatTime(dateString) {
            try {
                const date = new Date(dateString);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            } catch (e) {
                return '--:--';
            }
        }

        // Expor funções globalmente
        window.toggleActivity = toggleActivity;
        window.loadActivities = loadActivities;
    </script>
</body>
</html>
